<!DOCTYPE html>
<html>
<head>
    <title>Entity Pairs</title>
    <script type="text/javascript" src="dpd.js"></script>
    <script type="text/javascript" src="/js/md5.js"></script>
    <script type="text/javascript" src="/js/jquery-2.0.1.min.js"></script>
    <script type="text/javascript" src="/js/lodash.min.js"></script>
    <script type="text/javascript">

        var limit = 25;

        var people = {};

        function log(msg){

            $("#status").append("<p>" + msg + "</p>");
        }

        function buildQuery(skip){

           return {
               $limit: limit,
               $skip: skip * 25
           };
        }

        function buildNotHasSourceQuery(){

            return {
                $limit: limit,
                source: { $exists: false }
            };
        }

        function dump(result, error){

            if (error){
                log(error);
            }
            else {
                log("Updated.");
            }
        }

        function associatePerson(link, property, personId){

            if (_.has(people, personId)){

                console.log("Had one, saving you a trip!");

                doUpdate(link, personId, property, people[personId]);
            }
            else {

                if (personId.indexOf("unknown") == 0){

                    people[personId] = personId.slice(8);

                    doUpdate(link, personId, property, personId.slice(8));
                }
                else {
                    dpd.people.get(personId, function(person){

                        people[personId] = person.name;

                        doUpdate(link, personId, property, person.name);
                    });
                }
            }

        }

        function doUpdate(link, personid, property, name){

            var update = {};

            update[property] = personid;
            update[property + "Name"] = name;

            dpd.links.put(link.id, update, dump);
        }

        function bounce(skip){

           dpd.links.get(buildQuery(skip), function(links){

               links.forEach(function(link){

                   associatePerson(link, "source", link.node1);
                   associatePerson(link, "target", link.node2);
               });


               if (links.length === limit){

                  bounce(++skip);
               }
           });

        };

        function bounceNotHasSource(){

            dpd.links.get(buildNotHasSourceQuery(), function(links){

                links.forEach(function(link){

                    associatePerson(link, "source", link.node1);
                    associatePerson(link, "target", link.node2);
                });


                bounceNotHasSource();
            });
        }

        $(function(){

            //bounceNotHasSource();
        });

    </script>
</head>
<body>
<div id="status"></div>
</body>
</html>